<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Start-EventLogCollection ‚Äî Technical Specification | Databranch</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap');

  :root {
    --navy:       #0f1e35;
    --navy-mid:   #1a3154;
    --navy-light: #1e4a7a;
    --accent:     #2e8bff;
    --accent-dim: #1a5fbd;
    --teal:       #00c9b1;
    --white:      #f4f7fb;
    --text:       #d0dce8;
    --text-muted: #8a9bb5;
    --text-dim:   #5a6f8a;
    --border:     #1e3a5a;
    --border-mid: #2a4f72;
    --code-bg:    #0a1624;
    --row-alt:    #0d1e30;
    --success-bg: #0a2418;
    --success-border: #1a6640;
    --warn-bg:    #1e1a08;
    --warn-border:#7a6010;
    --note-bg:    #0a1a2e;
    --note-border:#1a4a7a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: var(--navy);
    color: var(--text);
    font-size: 15px;
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
  }

  @media print {
    body { background: #fff; color: #111; font-size: 12px; }
    .cover { background: #0f1e35 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .sidebar { display: none; }
    .main { margin-left: 0; }
    a { color: inherit; text-decoration: none; }
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .layout { display: flex; min-height: 100vh; }

  .sidebar {
    width: 260px; min-width: 260px;
    background: #080f1a;
    border-right: 1px solid var(--border);
    position: fixed; top: 0; left: 0; bottom: 0;
    overflow-y: auto; z-index: 100;
    padding: 0 0 40px 0;
  }
  .sidebar-logo {
    padding: 24px 20px 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
  }
  .sidebar-logo .company { font-size: 11px; font-weight: 600; letter-spacing: 0.15em; color: var(--teal); text-transform: uppercase; margin-bottom: 4px; }
  .sidebar-logo .doc-title { font-size: 13px; font-weight: 500; color: var(--white); line-height: 1.4; }
  .sidebar-logo .doc-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

  .sidebar nav { padding: 0 8px; }
  .nav-section { font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-dim); padding: 12px 12px 4px; }
  .nav-link { display: block; padding: 5px 12px; border-radius: 5px; font-size: 12.5px; color: var(--text-muted); text-decoration: none; transition: all 0.15s; line-height: 1.4; }
  .nav-link:hover { background: var(--navy-mid); color: var(--white); }
  .nav-link.active { background: var(--navy-light); color: var(--white); border-left: 2px solid var(--accent); padding-left: 10px; }
  .nav-link.sub { padding-left: 24px; font-size: 12px; }

  .main { margin-left: 260px; flex: 1; min-width: 0; }

  /* ‚îÄ‚îÄ Cover ‚îÄ‚îÄ */
  .cover {
    background: linear-gradient(145deg, #0a1828 0%, #0f2544 40%, #0a1e3a 100%);
    padding: 80px 80px 60px;
    border-bottom: 1px solid var(--border);
    position: relative; overflow: hidden;
  }
  .cover::before { content: ''; position: absolute; top: -80px; right: -80px; width: 400px; height: 400px; background: radial-gradient(circle, rgba(46,139,255,0.08) 0%, transparent 70%); border-radius: 50%; }
  .cover::after  { content: ''; position: absolute; bottom: -40px; left: 100px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(0,201,177,0.05) 0%, transparent 70%); border-radius: 50%; }
  .cover-eyebrow { font-size: 11px; font-weight: 600; letter-spacing: 0.2em; text-transform: uppercase; color: var(--teal); margin-bottom: 16px; }
  .cover-title { font-size: 42px; font-weight: 700; color: var(--white); line-height: 1.1; margin-bottom: 10px; letter-spacing: -0.02em; }
  .cover-script { font-family: 'IBM Plex Mono', monospace; font-size: 16px; color: var(--accent); margin-bottom: 8px; }
  .cover-type { font-size: 15px; color: var(--text-muted); font-weight: 300; font-style: italic; margin-bottom: 40px; }
  .cover-meta { display: flex; gap: 40px; flex-wrap: wrap; position: relative; z-index: 1; }
  .cover-meta-label { font-size: 10px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 3px; }
  .cover-meta-value { font-size: 14px; color: var(--text); font-weight: 500; }
  .cover-meta-value.mono { font-family: 'IBM Plex Mono', monospace; color: var(--accent); }

  /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
  .content { max-width: 900px; padding: 56px 80px 80px; }

  /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
  .section { margin-bottom: 60px; }

  h1 {
    font-size: 26px; font-weight: 700; color: var(--white);
    padding-bottom: 10px;
    border-bottom: 2px solid var(--navy-light);
    margin-bottom: 20px;
    letter-spacing: -0.01em;
  }
  h1::before { content: '//  '; color: var(--accent); font-family: 'IBM Plex Mono', monospace; font-size: 18px; font-weight: 400; }
  h2 { font-size: 18px; font-weight: 600; color: var(--accent); margin: 32px 0 12px; letter-spacing: -0.01em; }
  h3 { font-size: 12px; font-weight: 700; color: var(--teal); margin: 20px 0 8px; text-transform: uppercase; letter-spacing: 0.08em; }

  p { margin-bottom: 14px; color: var(--text); }
  strong { color: var(--white); font-weight: 600; }

  /* ‚îÄ‚îÄ Code ‚îÄ‚îÄ */
  .code-block {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: 6px;
    padding: 14px 18px;
    margin: 12px 0 20px;
    overflow-x: auto;
  }
  .code-block code { font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: #7dd3fc; white-space: pre; line-height: 1.7; }
  code.inline { font-family: 'IBM Plex Mono', monospace; font-size: 12.5px; background: var(--code-bg); color: #7dd3fc; padding: 2px 7px; border-radius: 4px; border: 1px solid var(--border); }
  .comment { color: #4a7a5a; }
  .keyword { color: #c084fc; }
  .string  { color: #86efac; }
  .var     { color: #fde68a; }

  /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; margin: 16px 0 24px; border-radius: 8px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
  thead tr { background: var(--navy-mid); }
  thead th { padding: 10px 16px; text-align: left; font-size: 10.5px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border-mid); }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:nth-child(even) { background: var(--row-alt); }
  tbody tr:hover { background: var(--navy-mid); }
  td { padding: 10px 16px; color: var(--text); vertical-align: top; line-height: 1.5; }
  td.mono { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #7dd3fc; white-space: nowrap; }
  td.num  { font-family: 'IBM Plex Mono', monospace; font-size: 18px; font-weight: 700; text-align: center; }

  /* ‚îÄ‚îÄ Callouts ‚îÄ‚îÄ */
  .callout { border-radius: 6px; padding: 14px 18px; margin: 16px 0; display: flex; gap: 12px; align-items: flex-start; }
  .callout-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .callout-body { flex: 1; }
  .callout-label { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 4px; }
  .callout-text { font-size: 13.5px; line-height: 1.6; }
  .callout.note { background: var(--note-bg); border: 1px solid var(--note-border); border-left: 3px solid var(--accent); }
  .callout.note .callout-label { color: var(--accent); }
  .callout.tip  { background: var(--success-bg); border: 1px solid var(--success-border); border-left: 3px solid #22c55e; }
  .callout.tip  .callout-label { color: #22c55e; }
  .callout.warn { background: var(--warn-bg); border: 1px solid var(--warn-border); border-left: 3px solid #eab308; }
  .callout.warn .callout-label { color: #eab308; }

  /* ‚îÄ‚îÄ Lists ‚îÄ‚îÄ */
  ul.styled { list-style: none; padding: 0; margin: 8px 0 16px; }
  ul.styled li { padding: 5px 0 5px 22px; position: relative; color: var(--text); font-size: 14px; line-height: 1.6; }
  ul.styled li::before { content: '‚ñ∏'; position: absolute; left: 0; color: var(--accent); font-size: 11px; top: 7px; }

  /* ‚îÄ‚îÄ Flow diagram ‚îÄ‚îÄ */
  .flow { display: flex; flex-direction: column; gap: 0; margin: 20px 0; }
  .flow-step {
    display: flex; align-items: flex-start; gap: 16px;
    padding: 16px 20px;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-bottom: none;
    position: relative;
  }
  .flow-step:first-child { border-radius: 8px 8px 0 0; }
  .flow-step:last-child  { border-radius: 0 0 8px 8px; border-bottom: 1px solid var(--border); }
  .flow-num {
    width: 28px; height: 28px; flex-shrink: 0;
    background: var(--navy-light);
    color: var(--accent);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
  }
  .flow-content { flex: 1; }
  .flow-title { font-size: 14px; font-weight: 600; color: var(--white); margin-bottom: 4px; }
  .flow-desc  { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
  .flow-badge { display: inline-block; font-family: 'IBM Plex Mono', monospace; font-size: 10px; padding: 1px 6px; border-radius: 3px; background: rgba(46,139,255,0.15); color: var(--accent); border: 1px solid rgba(46,139,255,0.25); margin-left: 8px; vertical-align: middle; }

  /* ‚îÄ‚îÄ Architecture diagram ‚îÄ‚îÄ */
  .arch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; }
  .arch-card { background: var(--code-bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .arch-card:hover { border-color: var(--accent); }
  .arch-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .arch-fn { font-family: 'IBM Plex Mono', monospace; font-size: 12.5px; color: var(--accent); font-weight: 500; }
  .arch-tag { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; padding: 2px 6px; border-radius: 3px; }
  .arch-tag.discovery  { background: rgba(0,201,177,0.12); color: var(--teal); border: 1px solid rgba(0,201,177,0.25); }
  .arch-tag.collection { background: rgba(46,139,255,0.12); color: var(--accent); border: 1px solid rgba(46,139,255,0.25); }
  .arch-tag.infra      { background: rgba(148,163,184,0.1); color: var(--text-muted); border: 1px solid var(--border); }
  .arch-tag.output     { background: rgba(34,197,94,0.1); color: #22c55e; border: 1px solid rgba(34,197,94,0.25); }
  .arch-desc { font-size: 12.5px; color: var(--text-muted); line-height: 1.5; }

  /* ‚îÄ‚îÄ Version history ‚îÄ‚îÄ */
  .version-entry { border: 1px solid var(--border); border-radius: 8px; margin: 12px 0; overflow: hidden; }
  .version-header { background: var(--navy-mid); padding: 12px 20px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid var(--border); }
  .version-num { font-family: 'IBM Plex Mono', monospace; font-size: 16px; font-weight: 600; color: var(--accent); }
  .version-meta { font-size: 12px; color: var(--text-muted); }
  .version-author { font-size: 12px; color: var(--teal); margin-left: auto; }
  .version-body { padding: 14px 20px; }
  .version-body ul { list-style: none; padding: 0; }
  .version-body ul li { padding: 3px 0 3px 18px; position: relative; font-size: 13.5px; color: var(--text); }
  .version-body ul li::before { content: '‚Äî'; position: absolute; left: 0; color: var(--text-dim); }

  /* ‚îÄ‚îÄ Severity matrix ‚îÄ‚îÄ */
  .sev-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 16px 0; }
  .sev-cell { background: var(--code-bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; text-align: center; }
  .sev-level { font-family: 'IBM Plex Mono', monospace; font-size: 12px; font-weight: 600; margin-bottom: 6px; }
  .sev-stream { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
  .sev-desc { font-size: 11px; color: var(--text-dim); line-height: 1.4; }

  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  .doc-footer { border-top: 1px solid var(--border); padding: 24px 80px; display: flex; justify-content: space-between; align-items: center; color: var(--text-dim); font-size: 12px; max-width: 900px; }
  .doc-footer .version { font-family: 'IBM Plex Mono', monospace; color: var(--text-muted); }

  /* ‚îÄ‚îÄ Badge ‚îÄ‚îÄ */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em; }
  .badge-blue  { background: rgba(46,139,255,0.15); color: var(--accent); border: 1px solid rgba(46,139,255,0.3); }
  .badge-teal  { background: rgba(0,201,177,0.12); color: var(--teal); border: 1px solid rgba(0,201,177,0.25); }
  .badge-green { background: rgba(34,197,94,0.12); color: #22c55e; border: 1px solid rgba(34,197,94,0.25); }
  .badge-amber { background: rgba(234,179,8,0.12); color: #eab308; border: 1px solid rgba(234,179,8,0.25); }
  .badge-red   { background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.25); }
</style>
</head>
<body>
<div class="layout">

  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="company">Databranch</div>
      <div class="doc-title">Start-EventLogCollection</div>
      <div class="doc-sub">Technical Specification</div>
    </div>
    <nav>
      <div class="nav-section">Specification</div>
      <a class="nav-link" href="#purpose">1. Purpose &amp; Scope</a>
      <a class="nav-link" href="#architecture">2. Script Architecture</a>
      <a class="nav-link sub" href="#structural-pattern">Structural Pattern</a>
      <a class="nav-link sub" href="#function-map">Sub-Function Map</a>
      <a class="nav-link" href="#parameters">3. Parameters</a>
      <a class="nav-link sub" href="#param-reference">Parameter Reference</a>
      <a class="nav-link sub" href="#datto-pattern">DattoRMM Pattern</a>
      <a class="nav-link" href="#modes">4. Operating Modes</a>
      <a class="nav-link sub" href="#automated">Automated Mode</a>
      <a class="nav-link sub" href="#custom">Custom Mode</a>
      <a class="nav-link" href="#precheck">5. Connectivity Pre-Check</a>
      <a class="nav-link" href="#parallel">6. Parallel Collection</a>
      <a class="nav-link sub" href="#ps51">PS 5.1 Runspaces</a>
      <a class="nav-link sub" href="#ps7">PS 7+ Parallel</a>
      <a class="nav-link" href="#collection">7. Collection Logic</a>
      <a class="nav-link sub" href="#filterhashtable">FilterHashtable</a>
      <a class="nav-link sub" href="#csv-format">CSV Format</a>
      <a class="nav-link" href="#logging">8. Logging Architecture</a>
      <a class="nav-link sub" href="#write-log">Write-Log</a>
      <a class="nav-link sub" href="#log-files">Log Files</a>
      <a class="nav-link" href="#errors">9. Error Handling</a>
      <a class="nav-link" href="#limitations">10. Limitations</a>
      <a class="nav-link" href="#changelog">11. Version History</a>
    </nav>
  </aside>

  <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ -->
  <div class="main">

    <!-- Cover -->
    <div class="cover">
      <div class="cover-eyebrow">Databranch Script Library</div>
      <div class="cover-title">Event Log Collection</div>
      <div class="cover-script">Start-EventLogCollection.ps1</div>
      <div class="cover-type">Technical Specification</div>
      <div class="cover-meta">
        <div class="cover-meta-item"><div class="cover-meta-label">Version</div><div class="cover-meta-value mono">v1.0.1.0</div></div>
        <div class="cover-meta-item"><div class="cover-meta-label">Date</div><div class="cover-meta-value">February 20, 2026</div></div>
        <div class="cover-meta-item"><div class="cover-meta-label">Author</div><div class="cover-meta-value">Josh Britton / Sam Kirsch</div></div>
        <div class="cover-meta-item"><div class="cover-meta-label">PS Minimum</div><div class="cover-meta-value mono">5.1</div></div>
        <div class="cover-meta-item"><div class="cover-meta-label">Run Context</div><div class="cover-meta-value">Domain Admin</div></div>
      </div>
    </div>

    <div class="content">

      <!-- 1. Purpose -->
      <div class="section" id="purpose">
        <h1>1. Purpose and Scope</h1>
        <p>
          <code class="inline">Start-EventLogCollection.ps1</code> consolidates two legacy scripts ‚Äî a local event log
          collector and a remote event log collector ‚Äî into a single unified tool. Its purpose is to provide Databranch
          engineers with an automated, reliable, and auditable mechanism for collecting Windows Event Log data from
          Windows Server environments during maintenance, incident response, and inventory activities.
        </p>
        <p>
          The script is designed to run from the primary domain controller or any domain-joined machine with Domain Admin
          rights, and is fully compatible with deployment via DattoRMM as a managed component.
        </p>
      </div>

      <!-- 2. Architecture -->
      <div class="section" id="architecture">
        <h1>2. Script Architecture</h1>

        <h2 id="structural-pattern">2.1 Structural Pattern</h2>
        <p>The script follows the Databranch PowerShell scripting standard with these structural elements:</p>
        <ul class="styled">
          <li>A script-level <code class="inline">param()</code> block handles all input, with DattoRMM environment variable fallback for every parameter.</li>
          <li>All logic is encapsulated inside a single master function named <code class="inline">Start-EventLogCollection</code>, matching the filename.</li>
          <li>All sub-functions are defined as nested definitions inside the master function, keeping the global scope clean.</li>
          <li>An entry point at the bottom of the file splats parameters into the master function using a hashtable.</li>
          <li>All status output uses the <code class="inline">Write-Log</code> helper which writes to both stdout and a persistent log file simultaneously.</li>
        </ul>

        <h2 id="function-map">2.2 Sub-Function Map</h2>
        <div class="arch-grid">
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Write-Log</div><div class="arch-tag infra">Infrastructure</div></div>
            <div class="arch-desc">Writes timestamped severity-tagged messages to stdout and a persistent log file. All output routes through this function.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Initialize-Logging</div><div class="arch-tag infra">Infrastructure</div></div>
            <div class="arch-desc">Creates the log folder on first run and rotates old log files, retaining the 10 most recent.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Initialize-OutputFolder</div><div class="arch-tag output">Output</div></div>
            <div class="arch-desc">Creates the timestamped output subfolder under the configured output root path for each run.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Get-LocalSubnets</div><div class="arch-tag discovery">Discovery</div></div>
            <div class="arch-desc">Queries local network adapters to enumerate active IPv4 subnets in CIDR notation, excluding loopback and link-local.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Get-SubnetIPs</div><div class="arch-tag discovery">Discovery</div></div>
            <div class="arch-desc">Expands a CIDR subnet string to an array of all valid host IP addresses using bitwise arithmetic. No external modules required.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Get-ServersFromAD</div><div class="arch-tag discovery">Discovery</div></div>
            <div class="arch-desc">Queries Active Directory for enabled computers with a Windows Server operating system using Get-ADComputer.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Get-ServersFromPingSweep</div><div class="arch-tag discovery">Discovery</div></div>
            <div class="arch-desc">Pings all IPs in provided subnets via parallel Start-Job, then fingerprints responders via CIM ‚Üí WinRM to confirm Windows Server OS.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Test-ServerConnectivity</div><div class="arch-tag infra">Infrastructure</div></div>
            <div class="arch-desc">Three-stage pre-flight check per server: ICMP ping, CIM Win32_OperatingSystem, then WinRM Invoke-Command fallback.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Invoke-ParallelCollection51</div><div class="arch-tag collection">Collection</div></div>
            <div class="arch-desc">Parallel collection engine for PowerShell 5.1. Uses a RunspacePool with configurable thread limit (default: 10).</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Invoke-ParallelCollection7</div><div class="arch-tag collection">Collection</div></div>
            <div class="arch-desc">Parallel collection engine for PowerShell 7+. Uses native ForEach-Object -Parallel with -ThrottleLimit.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Invoke-EventLogCollection</div><div class="arch-tag collection">Collection</div></div>
            <div class="arch-desc">Core per-server collection logic. Referenced in both parallel engines. Handles filtering, file cleanup, CSV export, and error isolation.</div>
          </div>
          <div class="arch-card">
            <div class="arch-card-header"><div class="arch-fn">Write-RunSummary</div><div class="arch-tag output">Output</div></div>
            <div class="arch-desc">Calculates run statistics from result objects and writes the human-readable summary file to the output folder.</div>
          </div>
        </div>
      </div>

      <!-- 3. Parameters -->
      <div class="section" id="parameters">
        <h1>3. Parameters</h1>

        <h2 id="param-reference">3.1 Parameter Reference</h2>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Parameter</th><th>Type</th><th>Default</th><th>Description</th></tr></thead>
            <tbody>
              <tr><td class="mono">-Mode</td><td class="mono">string</td><td class="mono">Automated</td><td><code class="inline">Automated</code> or <code class="inline">Custom</code>. Controls whether the script auto-discovers servers or uses a provided list.</td></tr>
              <tr><td class="mono">-ComputerName</td><td class="mono">string[]</td><td class="mono">(none)</td><td>Custom mode only. Accepts an array or comma-separated string of hostnames, FQDNs, or IPs.</td></tr>
              <tr><td class="mono">-Subnets</td><td class="mono">string[]</td><td class="mono">Auto</td><td>CIDR subnets for the ping sweep fallback. Auto-detected from local adapters if not provided.</td></tr>
              <tr><td class="mono">-DaysBack</td><td class="mono">int</td><td class="mono">30</td><td>Number of days back from today to collect events.</td></tr>
              <tr><td class="mono">-OutputPath</td><td class="mono">string</td><td class="mono">C:\Databranch</td><td>Root output folder. A timestamped subfolder is created here each run.</td></tr>
              <tr><td class="mono">-LogNames</td><td class="mono">string[]</td><td class="mono">Application, System</td><td>Event log names to target for collection.</td></tr>
              <tr><td class="mono">-SiteName</td><td class="mono">string</td><td class="mono">UnknownSite</td><td>DattoRMM: auto-populated from <code class="inline">CS_PROFILE_NAME</code> environment variable.</td></tr>
              <tr><td class="mono">-Hostname</td><td class="mono">string</td><td class="mono">$COMPUTERNAME</td><td>DattoRMM: auto-populated from <code class="inline">CS_HOSTNAME</code> environment variable.</td></tr>
            </tbody>
          </table>
        </div>

        <h2 id="datto-pattern">3.2 DattoRMM Environment Variable Pattern</h2>
        <p>Every parameter reads its value from a DattoRMM environment variable first, falling back to the passed parameter or a hardcoded default. This allows the same script to run unmodified both interactively and as a managed RMM component.</p>
        <div class="code-block"><code><span class="comment"># DattoRMM env var takes precedence; falls back to integer default</span>
[int]$DaysBack = $(if (<span class="var">$env:DaysBack</span>) { [int]<span class="var">$env:DaysBack</span> } else { 30 })

<span class="comment"># Array parameters accept comma-separated strings for DattoRMM single-line fields</span>
if (<span class="var">$ComputerName</span>.Count -eq 1 -and <span class="var">$ComputerName</span>[0] -like <span class="string">"*,*"</span>) {
    <span class="var">$ComputerName</span> = <span class="var">$ComputerName</span>[0] -split <span class="string">","</span> | ForEach-Object { <span class="var">$_</span>.Trim() }
}</code></div>
      </div>

      <!-- 4. Modes -->
      <div class="section" id="modes">
        <h1>4. Operating Modes</h1>

        <h2 id="automated">4.1 Automated Mode</h2>
        <p>Automated mode is the default and is intended for routine scheduled or on-demand collection across an entire environment. The local machine is always added to the target list first without a remote connectivity check. Discovery then proceeds in a two-stage chain:</p>

        <h3>Stage 1 ‚Äî Active Directory Query</h3>
        <p>The script imports the ActiveDirectory module and calls <code class="inline">Get-ADComputer</code> with a filter for <code class="inline">OperatingSystem -like "*Windows Server*"</code>. Only enabled computer accounts are included. This is the fastest and most accurate discovery method and relies on the AD <code class="inline">OperatingSystem</code> attribute being populated, which is standard for domain-joined Windows Servers.</p>

        <div class="callout warn">
          <div class="callout-icon">‚ö†Ô∏è</div>
          <div class="callout-body">
            <div class="callout-label">Fallback Trigger</div>
            <div class="callout-text">The ping sweep fallback only activates when AD returns zero results. If AD returns any servers ‚Äî even one ‚Äî the sweep is skipped entirely.</div>
          </div>
        </div>

        <h3>Stage 2 ‚Äî Ping Sweep with OS Fingerprinting (Fallback)</h3>
        <p>If AD returns no results, subnets are either taken from <code class="inline">-Subnets</code> or auto-detected via <code class="inline">Get-NetIPAddress</code>, excluding loopback and link-local addresses. Each CIDR subnet is expanded to host IPs using bitwise arithmetic in <code class="inline">Get-SubnetIPs</code> ‚Äî no external modules required.</p>
        <p>All host IPs are pinged in parallel using <code class="inline">Start-Job</code> (PS 5.1 compatible). Responders are fingerprinted: CIM <code class="inline">Win32_OperatingSystem.Caption</code> first, WinRM fallback if CIM fails. Only hosts where the OS caption contains "Windows Server" are added to the target list.</p>

        <div class="flow">
          <div class="flow-step">
            <div class="flow-num">1</div>
            <div class="flow-content">
              <div class="flow-title">Add local machine <span class="flow-badge">Always</span></div>
              <div class="flow-desc">Local machine is added first, skips remote pre-check entirely.</div>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-num">2</div>
            <div class="flow-content">
              <div class="flow-title">AD Query ‚Äî Get-ADComputer <span class="flow-badge">Primary</span></div>
              <div class="flow-desc">Filter: OperatingSystem like "*Windows Server*" AND Enabled = True.</div>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-num">3</div>
            <div class="flow-content">
              <div class="flow-title">Ping Sweep <span class="flow-badge">Fallback ‚Äî AD = 0 results</span></div>
              <div class="flow-desc">Auto-detected or override subnets expanded to host IPs. Parallel Start-Job pings.</div>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-num">4</div>
            <div class="flow-content">
              <div class="flow-title">OS Fingerprinting ‚Äî CIM ‚Üí WinRM <span class="flow-badge">Fallback only</span></div>
              <div class="flow-desc">Confirms each ping responder is Windows Server before inclusion.</div>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-num">5</div>
            <div class="flow-content">
              <div class="flow-title">Deduplicate combined list</div>
              <div class="flow-desc">Sort-Object -Unique removes any overlap between AD and sweep results.</div>
            </div>
          </div>
        </div>

        <h2 id="custom">4.2 Custom Mode</h2>
        <p>Custom mode bypasses all discovery logic. The operator provides a <code class="inline">-ComputerName</code> list accepted as a PowerShell array or comma-separated string. Custom mode still runs the full connectivity pre-check against each target before attempting collection, ensuring unreachable or invalid targets fail cleanly rather than hanging the collection engine.</p>
      </div>

      <!-- 5. Pre-Check -->
      <div class="section" id="precheck">
        <h1>5. Connectivity Pre-Check</h1>
        <p>Before any event log collection is attempted against a remote server, <code class="inline">Test-ServerConnectivity</code> runs a three-stage check. The local machine always bypasses this check.</p>

        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Method</th><th>Timeout</th><th>Purpose</th></tr></thead>
            <tbody>
              <tr>
                <td class="mono">1</td>
                <td><strong>ICMP Ping</strong></td>
                <td>Default</td>
                <td>Fast initial reachability check. Non-responding hosts are immediately marked unreachable and skipped, avoiding long CIM timeouts on dead IPs.</td>
              </tr>
              <tr>
                <td class="mono">2</td>
                <td><strong>CIM Win32_OperatingSystem</strong></td>
                <td>15 seconds</td>
                <td>Confirms host is reachable via CIM/DCOM and retrieves OS name for logging. If successful, the server passes pre-check.</td>
              </tr>
              <tr>
                <td class="mono">3</td>
                <td><strong>WinRM Invoke-Command</strong></td>
                <td>Default</td>
                <td>Fallback if CIM fails. Lightweight Invoke-Command retrieves OS info. If this also fails, the server is added to the SkippedServers list.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p>Skipped servers are tracked in a <code class="inline">$SkippedServers</code> list reported in the run summary. The OS name retrieved during pre-check is logged for audit purposes.</p>
      </div>

      <!-- 6. Parallel -->
      <div class="section" id="parallel">
        <h1>6. Parallel Collection Engine</h1>

        <h2>Runtime PS Version Detection</h2>
        <p>The script detects the running PowerShell major version at runtime and routes to the appropriate parallel engine. No modification needed ‚Äî the same script file works correctly on PS 5.1 and PS 7+.</p>
        <div class="code-block"><code><span class="var">$PSMajor</span> = <span class="var">$PSVersionTable</span>.PSVersion.Major

if (<span class="var">$PSMajor</span> -ge 7) {
    Invoke-ParallelCollection7 <span class="keyword">...</span>    <span class="comment"># ForEach-Object -Parallel</span>
} else {
    Invoke-ParallelCollection51 <span class="keyword">...</span>  <span class="comment"># RunspacePool</span>
}</code></div>

        <h2 id="ps51">6.2 PowerShell 5.1 ‚Äî Runspace Pool</h2>
        <p>On PS 5.1, a <code class="inline">RunspacePool</code> is created with a configurable maximum thread count (default: 10). Each server is assigned to a self-contained <code class="inline">PowerShell</code> instance. Because runspaces do not share scope with the parent session, the collection script block is fully self-contained ‚Äî no outer variable or function references.</p>
        <p>All log messages generated inside a runspace are buffered in a <code class="inline">Log</code> array within the result object and flushed to the main <code class="inline">Write-Log</code> function after the thread completes. This ensures log file writes happen safely from the main thread, avoiding concurrent file access issues.</p>

        <div class="callout note">
          <div class="callout-icon">üîß</div>
          <div class="callout-body">
            <div class="callout-label">Pipeline Pollution ‚Äî Design Note</div>
            <div class="callout-text">
              Discovery functions that both write log messages and return values use the unary comma operator
              (<code class="inline">return ,$list</code>) and pipe <code class="inline">Write-Log</code> calls to
              <code class="inline">| Out-Null</code>. Without this pattern, PowerShell 5.1 captures Write-Output log
              strings as part of the function's return value ‚Äî a critical gotcha when mixing output and return values in the same pipeline.
            </div>
          </div>
        </div>

        <h2 id="ps7">6.3 PowerShell 7+ ‚Äî ForEach-Object -Parallel</h2>
        <p>On PS 7+, <code class="inline">ForEach-Object -Parallel</code> is used with <code class="inline">-ThrottleLimit</code> matching the configured maximum threads. Parent-scope variables are accessed via the <code class="inline">$using:</code> scope modifier. Results accumulate as PSCustomObject hashtables with a <code class="inline">Log</code> field that is flushed back to <code class="inline">Write-Log</code> after parallel execution completes, keeping output ordered and readable.</p>
      </div>

      <!-- 7. Collection Logic -->
      <div class="section" id="collection">
        <h1>7. Event Log Collection Logic</h1>

        <h2 id="filterhashtable">7.1 FilterHashtable Performance</h2>
        <p>Event filtering uses <code class="inline">Get-WinEvent</code> with a <code class="inline">FilterHashtable</code> rather than a pipeline <code class="inline">Where-Object</code>. This is a significant performance distinction:</p>

        <div class="table-wrap">
          <table>
            <thead><tr><th>Method</th><th>Filtering Occurs At</th><th>Performance</th></tr></thead>
            <tbody>
              <tr><td><strong>FilterHashtable</strong> ‚úì</td><td>ETW provider level ‚Äî before events load into memory</td><td><span class="badge badge-green">Optimal</span></td></tr>
              <tr><td>Where-Object</td><td>Post-load ‚Äî all events loaded then discarded</td><td><span class="badge badge-amber">Slow on large logs</span></td></tr>
            </tbody>
          </table>
        </div>

        <div class="code-block"><code><span class="var">$filterHash</span> = @{
    LogName   = <span class="var">$LogName</span>
    StartTime = <span class="var">$StartDate</span>
    Level     = @(1, 2)   <span class="comment"># 1 = Critical, 2 = Error ‚Äî numeric, locale-independent</span>
}</code></div>

        <p>The <code class="inline">Level</code> values 1 and 2 are the numeric Windows event severity identifiers. Using numeric values is more reliable than filtering on <code class="inline">LevelDisplayName</code> strings, which can vary by system locale.</p>

        <h2>7.2 Local vs Remote Collection</h2>
        <p>The collection block detects whether the target is the local machine by comparing the server name to <code class="inline">$env:COMPUTERNAME</code> and the strings <code class="inline">localhost</code> and <code class="inline">127.0.0.1</code>. When local, <code class="inline">Get-WinEvent</code> is called without <code class="inline">-ComputerName</code>, avoiding unnecessary WinRM round-trips and working regardless of whether remote management is configured on the local machine.</p>

        <h2 id="csv-format">7.3 Output CSV Format</h2>
        <p>CSVs are written with <code class="inline">-NoTypeInformation</code> and <code class="inline">-Encoding UTF8</code>. The script adds server-context columns absent in the original scripts:</p>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Column</th><th>Source</th><th>Notes</th></tr></thead>
            <tbody>
              <tr><td class="mono">Server</td><td>Injected</td><td>Target server name ‚Äî added to make each CSV a standalone artifact.</td></tr>
              <tr><td class="mono">LogName</td><td>Injected</td><td>Event log name ‚Äî useful when opening files outside their folder context.</td></tr>
              <tr><td class="mono">Level</td><td>WinEvent.LevelDisplayName</td><td>Critical or Error.</td></tr>
              <tr><td class="mono">EventId</td><td>WinEvent.Id</td><td>Numeric Windows Event ID.</td></tr>
              <tr><td class="mono">Source</td><td>WinEvent.ProviderName</td><td>Component or application that raised the event.</td></tr>
              <tr><td class="mono">TimeCreated</td><td>WinEvent.TimeCreated</td><td>Timestamp of the event.</td></tr>
              <tr><td class="mono">Message</td><td>WinEvent.Message</td><td>Full event description text.</td></tr>
            </tbody>
          </table>
        </div>
        <p>File naming: <code class="inline">ServerName LogName Event Log.csv</code>. Characters invalid in Windows file paths are replaced with underscores before the filename is constructed.</p>
      </div>

      <!-- 8. Logging -->
      <div class="section" id="logging">
        <h1>8. Logging Architecture</h1>

        <h2 id="write-log">8.1 Write-Log Severity Levels</h2>
        <div class="sev-grid">
          <div class="sev-cell">
            <div class="sev-level" style="color:#60a5fa;">INFO</div>
            <div class="sev-stream">Write-Output</div>
            <div class="sev-desc">Normal progress. Always visible in DattoRMM job output.</div>
          </div>
          <div class="sev-cell">
            <div class="sev-level" style="color:#22c55e;">SUCCESS</div>
            <div class="sev-stream">Write-Output</div>
            <div class="sev-desc">Step completed as expected ‚Äî file written, server reachable.</div>
          </div>
          <div class="sev-cell">
            <div class="sev-level" style="color:#a78bfa;">DEBUG</div>
            <div class="sev-stream">Write-Output</div>
            <div class="sev-desc">Internal detail. Visible in output and log file. Safe to ignore.</div>
          </div>
          <div class="sev-cell">
            <div class="sev-level" style="color:#eab308;">WARN</div>
            <div class="sev-stream">Write-Warning</div>
            <div class="sev-desc">Non-fatal unexpected condition. Script continues.</div>
          </div>
          <div class="sev-cell">
            <div class="sev-level" style="color:#ef4444;">ERROR</div>
            <div class="sev-stream">Write-Error</div>
            <div class="sev-desc">Specific task failed. Script continues with remaining targets.</div>
          </div>
        </div>
        <p>Log entry format: <code class="inline">[yyyy-MM-dd HH:mm:ss] [SEVERITY] Message</code></p>

        <h2 id="log-files">8.2 Log File Location and Rotation</h2>
        <p>Log files are written to <code class="inline">C:\Databranch\ScriptLogs\Start-EventLogCollection\</code>. One file per calendar day: <code class="inline">Start-EventLogCollection_yyyy-MM-dd.log</code>. <code class="inline">Initialize-Logging</code> enforces a maximum of 10 files ‚Äî the oldest are deleted when the limit is exceeded.</p>

        <h2>8.3 Run Summary File</h2>
        <p>Each run generates a standalone summary file inside the timestamped output folder containing: run metadata, discovery statistics, collection result counts (succeeded / partial / failed / no-events), output folder path, skipped server list with reasons, and detailed error messages per failed server.</p>
      </div>

      <!-- 9. Error Handling -->
      <div class="section" id="errors">
        <h1>9. Error Handling</h1>

        <h2>9.1 Global Error Policy</h2>
        <p><code class="inline">$ErrorActionPreference = 'Stop'</code> is set at the start of the main execution block, converting non-terminating errors into terminating errors. A top-level try/catch wraps the entire execution block and exits with code 2 on any unhandled fatal exception.</p>

        <h2>9.2 Per-Server Isolation</h2>
        <p>Each server's collection is isolated ‚Äî an error on one server does not interrupt others. Each log name within a server is wrapped in its own try/catch. The <code class="inline">"No events were found"</code> exception is treated as INFO rather than ERROR ‚Äî it is a normal condition when a log has no matching events in the collection window, not a failure.</p>

        <h2>9.3 Exit Codes</h2>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Code</th><th>Meaning</th><th>Condition</th></tr></thead>
            <tbody>
              <tr><td class="num" style="color:#22c55e;">0</td><td><strong>Success</strong></td><td>All servers collected without any log-level failures.</td></tr>
              <tr><td class="num" style="color:#eab308;">1</td><td><strong>Partial success</strong></td><td>One or more servers had collection failures, but at least one server succeeded fully.</td></tr>
              <tr><td class="num" style="color:#ef4444;">2</td><td><strong>Complete failure</strong></td><td>All attempted servers failed, or a fatal unhandled exception occurred before collection began.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 10. Limitations -->
      <div class="section" id="limitations">
        <h1>10. Known Limitations</h1>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Limitation</th><th>Detail</th></tr></thead>
            <tbody>
              <tr>
                <td><strong>Ping sweep scale</strong></td>
                <td>Sweeping a /16 or larger subnet generates thousands of parallel jobs and can be slow or memory-intensive on PS 5.1. The sweep is intended for /24 environments. The AD query is the expected primary path for production use.</td>
              </tr>
              <tr>
                <td><strong>AD OperatingSystem attribute</strong></td>
                <td>The AD query relies on the OperatingSystem attribute being accurate on each computer account. Stale or manually-modified accounts may produce false positives or miss valid servers.</td>
              </tr>
              <tr>
                <td><strong>WinRM dependency</strong></td>
                <td>Remote collection requires WinRM to be enabled and accessible on target servers. Environments where WinRM is disabled by policy will require CIM/DCOM connectivity at minimum.</td>
              </tr>
              <tr>
                <td><strong>Large event log volume</strong></td>
                <td>Servers with many Critical/Error events may produce large CSV files. Collection time and file size scale with event volume.</td>
              </tr>
              <tr>
                <td><strong>No progress bar in runspaces</strong></td>
                <td>Write-Progress cannot be called from within runspace threads on PS 5.1. Progress is conveyed through log messages only.</td>
              </tr>
              <tr>
                <td><strong>Single credential context</strong></td>
                <td>The script uses the credentials of the running account only. It does not support -Credential injection for targeting servers under different accounts.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 11. Version History -->
      <div class="section" id="changelog">
        <h1>11. Version History</h1>

        <div class="version-entry">
          <div class="version-header">
            <div class="version-num">v1.0.1.0</div>
            <div class="version-meta">February 20, 2026</div>
            <div class="version-author">Sam Kirsch</div>
          </div>
          <div class="version-body">
            <ul>
              <li>Fixed PS pipeline pollution in <code class="inline">Get-ServersFromAD</code>, <code class="inline">Get-LocalSubnets</code>, and <code class="inline">Get-ServersFromPingSweep</code> ‚Äî Write-Log calls inside return-value functions were leaking log strings into the target server list. Resolved by redirecting Write-Log output with <code class="inline">| Out-Null</code> and using Generic List with unary comma return.</li>
              <li>Fixed <code class="inline">Write-Log</code> rejecting empty strings (summary heredoc contains blank separator lines). Changed <code class="inline">$Message</code> from <code class="inline">Mandatory=$true</code> to <code class="inline">Mandatory=$false</code> with <code class="inline">[AllowEmptyString()]</code>.</li>
            </ul>
          </div>
        </div>

        <div class="version-entry">
          <div class="version-header">
            <div class="version-num">v1.0.0.0</div>
            <div class="version-meta">February 20, 2026</div>
            <div class="version-author">Sam Kirsch</div>
          </div>
          <div class="version-body">
            <ul>
              <li>Initial release. Merged local collector (v1.2, J. Britton 2019) and remote collector (v1.0, J. Britton 2019) into a single unified script.</li>
              <li>Added Automated and Custom operating modes.</li>
              <li>Implemented AD query discovery with ping sweep + CIM/WinRM OS fingerprinting fallback chain.</li>
              <li>Runtime PS version detection: runspace pool engine (5.1) and ForEach-Object -Parallel engine (7+).</li>
              <li>Connectivity pre-check (ping ‚Üí CIM ‚Üí WinRM) before collection on each target.</li>
              <li>Timestamped output subfolder per run under C:\Databranch.</li>
              <li>Rich logging with Write-Log, log rotation, and per-run summary file.</li>
              <li>Full DattoRMM environment variable compatibility for all parameters.</li>
              <li>Exit codes: 0 (success), 1 (partial), 2 (failure).</li>
              <li>Added Server, LogName, and Source columns to CSV output for standalone artifact value.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="doc-footer">
        <div>Databranch &mdash; Confidential</div>
        <div class="version">Start-EventLogCollection.ps1 &nbsp;|&nbsp; v1.0.1.0 &nbsp;|&nbsp; Feb 2026</div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /layout -->

<script>
  const sections = document.querySelectorAll('.section[id]');
  const navLinks = document.querySelectorAll('.nav-link');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        navLinks.forEach(l => l.classList.remove('active'));
        const link = document.querySelector(`.nav-link[href="#${e.target.id}"]`);
        if (link) link.classList.add('active');
      }
    });
  }, { rootMargin: '-20% 0px -70% 0px' });
  sections.forEach(s => observer.observe(s));
</script>
</body>
</html>
