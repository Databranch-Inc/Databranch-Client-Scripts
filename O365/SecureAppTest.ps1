# Replace with your own variables
$ApplicationID = "d800ccf8-991c-485e-9dd8-9df4e32320ba"
$applicationsecret = "Dylcxpd621Mowk9iiHMMkKIWmsl3r+FwPDqjoK6n7TE="
$refreshtoken = "0.ATgAzwnPGNj0l066qsW-jrQKPfjMANgcmV5Indid9OMjILo4AHM.AgABAAEAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P_MdY4xhyBLXjNWmayhwnCNH6n0h0JIfifIqAwR4R1JwxHSsklbzWg2sjWB93YKaey8lURK1T6E4CmUfDe0dfj2ytc809Rj7HT-wSRvj4c5t1yX5XsG6wNpUaBat4meQXEOZ7PhfOOhQd8CfzmQYnIBRzubKKuwKPhUTZ_piCUgFCw8ra3K81haPBjZqpYxaI7ND5BNJGJQmFAzjPOjuNET3haigD3qphScW5fA-nzBBIWwW33XjQJDldcEpZCEIEUVf0h7FUU3agl9e5RYrdTzSzfJhD4csUKPGx8LXGUNkhAt7mOA64jl-EyIQZ-roiaocI_s7zqkjsSXdKlWlx9FUSj_wdAcgW3qtWwzQbuImqfNl62qEI07UsKl5qVe-M24czneD46YhsIGy37mF8FNIDOe7KF7YdntPkrGaiH5i2wqX7qpU-9y6Dr5hUWGqo_iixBWEOKepJ9--sB30HeoDoGn0hjKJtwyp4ArbadwJUwk1kHUd4XlnWqQwdNPsIvNnGHG6mWHG31pTi70uQTuI6Z_wg-Q4hXYQHtrQEz5Vs8YPl-AQvWcLykhY8G6mh-PNZofDiUS4dWiqss8-l8v3mQfeEbC0F8sk9SO453TQLK1v1gbthajWzTQCUZELHYQeVXOU88eRyOQpU-rBFMcP3hj1-7fqQQptc46wBHPKcDs2SEw-yKZRC2atGOF7RDTXQCkucvyhQSUNNUhEdG-QDzr9tQOwUf-_I-LclKaYimLEwwEgPhPUJJdygwBK6_GpOYRLXJxS9DvnaFcfinSAUy4D17DiuVGPu6kyFMqS_dWDMKLN7pZZrG0sg8MmersqbeKFKqS46jbHYi8u2Tavc4EIDAbtPW1vzFVQdyhfA3W0tXM5rfoXw8M_zKseQJAHg"
$exchangerefreshtoken = "0.ATgAzwnPGNj0l066qsW-jrQKPRY8x6Djp2RFmpUr30c4NxY4AHM.AgABAAEAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P_9B67Fl2zawlRyRyYLys4rc7AzKiZvEATxKl_PN-EKqLce8oS1S7jUZLZvZDRxkw--m8spypXuFIIoJoClrcclfJJcokwHx_1_Wu85k1bjL6Zit25eTwoY1red48g7fZvF8w5IxO0zf_-al7KPZRK-ajsi7fhoIRQaurviqLxWaPvNa0pLmIx_Z_jE04RMfHIcEhrck-14DYRVPFNTx6Ccs5YrWhcyHq_dLCgcYl5dZfmw8EAYO_sm-r8BrYVVyIKYWsoB4bJ49_ilrPhCD7EaOHToGureH72ONV2QjhArMwVidxw-hLgxpBe7NIYrOasMoFU0zAy48mqwCd8dpODSktGCiYpX-lB5uWj0vH2LShF3xe1sdhFdk6Zb9yglBRQGAyfVApn3jiW7HWBalbB0IGP-BlQBWbiUCDxl1Fhg8jnCpswzNauSCyyc6vbiReOTGBOPAQDCVw1P4uVO_M-UrXej6JHNv58DSNtrvXFsliel_LUUcJFnJcdY9Ho6KrekM-SUFN9OvMKPqKXIXAIOqn3I5WURGWaEB266B1HOsgFSlsFxnAhEXFnFyeHbzHkiDJbnjydOQGb9bNrz1s4IaKRmuCBsMUeTpxuJEtkl0-0-8au19Xae_vT0XZEDEpcrtNaWOW-CBB7AVGI2X6y-AqusuyR5mtQII-wQCVjA1-5exxDCDO79axwz6BlQJrJO3Xy6_jmOkf6909H2WDIbHSkczScPQRC6rDnUoyC2_awFcXEZcj1Py-GMbVGMzupQjhu8V9ajVl5gxRzE0sCkZLOFZufUPd0EyRXhoLb2FZ4LU78bJo3ARA"
$MyTenant = "databranch.onmicrosoft.com"
$AzureRefreshToken = "0.ATgAzwnPGNj0l066qsW-jrQKPfjMANgcmV5Indid9OMjILo4AHM.AgABAAEAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P_cvYs7rcpSWLg-zWVy4Wnv4TNNo1bWgeNlvNGBWAwUMQ4dBBGCvGiDJJINvGla1D4mbxg7sKRY8iOWa00OT1fKMJvSVWW7_PZkr8gUHTllS737v2yjIi_y9JuPuzQygTz6DZ0wWMR3MCZ0d29w8tWFGSKEqyQtRf3-mkEa72D0BG8u2WHsX4kwhPX70Z2giITT9iXUmDsnkCAvYKdQv9pFZAplfwVGsm4LMdIKv6ixHelLCVCIlqPvGcl9GDWXpNSW9qlVHUzAoNd0MrLJxEQKUM5oEjrYSxe1o5O8FTal1WJxKE1NYfZy5PIFWnbZ8zRM52QNo7C2egXlRzbjP1gC2IoPlMLlJWcxS-7VrMwD2j7JvE_cYTQIbt2WOKbiD6jd93ctEVH7yVzuxgpVtvIQcyFaX-fI13ODPq0P9RfikqXPoCPfIPG1fCGKsLu-7P9dmpAdFTg5pyixfnvTvtfOwMrjUL6zaqaA89E7ODQI5EgOvWsazxjDaxAggqhr6mDuGoIIsaunNGh11vMUMPJ9gCK9r7kiMfA3SXOegXZWtyQZafTPnQpse1VdQuQr4Niufg3WST5Exv-XiGI6sW7xYGlLentwqvdIelVAgB_xJnTJCp_gV6vxC6nUUIoPNtyal9_jMlsCqcMDPBimLY01tOH9jP7hXVMKdcxr0RxDtq2MTGsrSbsL6Tpm02c-5fLuuPk19ujPDV75Svo2cBpxqQtWPWEdBrflDwrubz05p7tlgz9P89sulVFkWNIOgf5CE1V_bUpAV9_k-Tj50lGgPJ-CdHXuxDKW8837cCBXPbu4UhMYgS60W2JMdan2hdCYGI2a3tP4pcOCvbmkuY9T1_ZU8Imka952mRsCq4JDuI2Y83f2piw"
# Do not edit below this line

function Get-GraphToken($tenantid, $scope, $AsApp, $AppID, $erefreshToken, $ReturnRefresh) {
    if (!$scope) { $scope = 'https://graph.microsoft.com/.default' }

    $AuthBody = @{
        client_id     = $ApplicationId
        client_secret = $ApplicationSecret
        scope         = $Scope
        refresh_token = $eRefreshToken
        grant_type    = "refresh_token"
                    
    }

    if ($null -ne $AppID -and $null -ne $erefreshToken) {
        $AuthBody = @{
            client_id     = $appid
            refresh_token = $eRefreshToken
            scope         = $Scope
            grant_type    = "refresh_token"
        }
    }

    if (!$tenantid) { $tenantid = $env:tenantid }
    $AccessToken = (Invoke-RestMethod -Method post -Uri "https://login.microsoftonline.com/$($tenantid)/oauth2/v2.0/token" -Body $Authbody -ErrorAction Stop)
    if ($ReturnRefresh) { $header = $AccessToken } else { $header = @{ Authorization = "Bearer $($AccessToken.access_token)" } }

    return $header
}
function Connect-graphAPI {
    [CmdletBinding()]
    Param
    (
        [parameter(Position = 0, Mandatory = $false)]
        [ValidateNotNullOrEmpty()][String]$ApplicationId,
         
        [parameter(Position = 1, Mandatory = $false)]
        [ValidateNotNullOrEmpty()][String]$ApplicationSecret,
         
        [parameter(Position = 2, Mandatory = $true)]
        [ValidateNotNullOrEmpty()][String]$TenantID,
 
        [parameter(Position = 3, Mandatory = $false)]
        [ValidateNotNullOrEmpty()][String]$RefreshToken
 
    )
    Write-Verbose "Removing old token if it exists"
    $Script:GraphHeader = $null
    Write-Verbose "Logging into Graph API"
    try {
        if ($ApplicationId) {
            Write-Verbose "   using the entered credentials"
            $script:ApplicationId = $ApplicationId
            $script:ApplicationSecret = $ApplicationSecret
            $script:RefreshToken = $RefreshToken
            $AuthBody = @{
                client_id     = $ApplicationId
                client_secret = $ApplicationSecret
                scope         = 'https://graph.microsoft.com/.default'
                refresh_token = $RefreshToken
                grant_type    = "refresh_token"
                
            }
             
        }
        else {
            Write-Verbose "   using the cached credentials"
            $AuthBody = @{
                client_id     = $script:ApplicationId
                client_secret = $Script:ApplicationSecret
                scope         = 'https://graph.microsoft.com/.default'
                refresh_token = $script:RefreshToken
                grant_type    = "refresh_token"
                
            }
        }
        $AccessToken = (Invoke-RestMethod -Method post -Uri "https://login.microsoftonline.com/$($tenantid)/oauth2/v2.0/token" -Body $Authbody -ErrorAction Stop).access_token
 
        $Script:GraphHeader = @{ Authorization = "Bearer $($AccessToken)" }
    }
    catch {
        Write-Host "Could not log into the Graph API for tenant $($TenantID): $($_.Exception.Message)" -ForegroundColor Red
    }
 
}
 
write-host "Starting test of the standard Refresh Token" -ForegroundColor Green

try {
    write-host "Attempting to retrieve an Access Token" -ForegroundColor Green
    Connect-graphAPI -ApplicationId $applicationid -ApplicationSecret $applicationsecret -RefreshToken $refreshtoken -TenantID $MyTenant
}
catch {
    $ErrorDetails = if ($_.ErrorDetails.Message) {
        $ErrorParts = $_.ErrorDetails.Message | ConvertFrom-Json
        "[$($ErrorParts.error)] $($ErrorParts.error_description)"
    }
    else {
        $_.Exception.Message
    }
    Write-Host "Unable to generate access token. The detailed error information, if returned was: $($ErrorDetails)" -ForegroundColor Red
}

try {
    write-host "Attempting to retrieve all tenants you have delegated permission to" -ForegroundColor Green
    $Tenants = (Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/contracts?`$top=999" -Method GET -Headers $script:GraphHeader).value
}
catch {
    $ErrorDetails = if ($_.ErrorDetails.Message) {
        $ErrorParts = $_.ErrorDetails.Message | ConvertFrom-Json
        "[$($ErrorParts.error)] $($ErrorParts.error_description)"
    }
    else {
        $_.Exception.Message
    }
    Write-Host "Unable to retrieve tenants. The detailed error information, if returned was: $($ErrorDetails)" -ForegroundColor Red
}

# Setup some variables for use in the foreach. Pay no attention to the man behind the curtain....
$TenantCount = $Tenants.Count
$IncrementAmount = 100 / $TenantCount
$i = 0
$ErrorCount = 0

write-host "$TenantCount tenants found, attempting to loop through each to test access to each individual tenant" -ForegroundColor Green
# Loop through every tenant we have, and attempt to interact with it with Graph
foreach ($Tenant in $Tenants) {
    Write-Progress -Activity "Checking Tenant - Refresh Token" -Status "Progress -> Checking $($Tenant.defaultDomainName)" -PercentComplete $i -CurrentOperation TenantLoop
    If ($i -eq 0) { Write-Host "Starting Refresh Token Loop Tests" }
    $i = $i + $IncrementAmount

    try {
        Connect-graphAPI -ApplicationId $applicationid -ApplicationSecret $applicationsecret -RefreshToken $refreshtoken -TenantID $tenant.customerid
    }
    catch {
        $ErrorDetails = if ($_.ErrorDetails.Message) {
            $ErrorParts = $_.ErrorDetails.Message | ConvertFrom-Json
            "[$($ErrorParts.error)] $($ErrorParts.error_description)"
        }
        else {
            $_.Exception.Message
        }
        Write-Host "Unable to connect to graph API for $($Tenant.defaultDomainName). The detailed error information, if returned was: $($ErrorDetails)" -ForegroundColor Red
        $ErrorCount++
        continue
    }


    try {
        $Result = (Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/users" -Method GET -Headers $script:GraphHeader).value
    }
    catch {
        $ErrorDetails = if ($_.ErrorDetails.Message) {
            $ErrorParts = $_.ErrorDetails.Message | ConvertFrom-Json
            "[$($ErrorParts.error)] $($ErrorParts.error_description)"
        }
        else {
            $_.Exception.Message
        }
        Write-Host "Unable to get users from $($Tenant.defaultDomainName) in Refresh Token Test. The detailed error information, if returned was: $($ErrorDetails)" -ForegroundColor Red
        $ErrorCount++
    }
    
}

Write-Host "Standard Graph Refresh Token Test: $TenantCount total tenants, with $ErrorCount failures"
Write-Host "Now attempting to test the Exchange Refresh Token"

# Setup some variables for use in the foreach. Pay no attention to the man behind the curtain....
$j = 0
$ExcErrorCount = 0

foreach ($Tenant in $Tenants) {
    Write-Progress -Activity "Checking Tenant - Exchange Refresh Token" -Status "Progress -> Checking $($Tenant.defaultDomainName)" -PercentComplete $j -CurrentOperation TenantLoop
    If ($j -eq 0) { Write-Host "Starting Exchange Refresh Token Test" }
    $j = $j + $IncrementAmount

    try {
        $upn = "notRequired@required.com"
        $tokenvalue = ConvertTo-SecureString (Get-GraphToken -AppID 'a0c73c16-a7e3-4564-9a95-2bdf47383716' -ERefreshToken $ExchangeRefreshToken -Scope 'https://outlook.office365.com/.default' -Tenantid $tenant.defaultDomainName).Authorization -AsPlainText -Force
        $credential = New-Object System.Management.Automation.PSCredential($upn, $tokenValue)
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri "https://ps.outlook.com/powershell-liveid?DelegatedOrg=$($tenant.defaultDomainName)&BasicAuthToOAuthConversion=true" -Credential $credential -Authentication Basic -AllowRedirection -ErrorAction Continue
        $session = Import-PSSession $session -ea Silentlycontinue -AllowClobber -CommandName "Get-OrganizationConfig"
        $org = Get-OrganizationConfig
        $null = Get-PSSession | Remove-PSSession
    }
    catch {
        $ErrorDetails = if ($_.ErrorDetails.Message) {
            $ErrorParts = $_.ErrorDetails.Message | ConvertFrom-Json
            "[$($ErrorParts.error)] $($ErrorParts.error_description)"
        }
        else {
            $_.Exception.Message
        }
        Write-Host "Tenant: $($Tenant.defaultDomainName)-----------------------------------------------------------------------------------------------------------" -ForegroundColor Yellow
        Write-Host "Failed to Connect to Exchange for $($Tenant.defaultDomainName). The detailed error information, if returned was: $($ErrorDetails)" -ForegroundColor Red        
        $ExcErrorCount++
    }
}

Write-Host "Exchange Refresh Token Test: $TenantCount total tenants, with $ExcErrorCount failures"
Write-Host "All Tests Finished"
